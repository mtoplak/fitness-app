name: CI/CD Pipeline

on:
  push:
    branches: [ main, pre-production, production ]
  pull_request:
    branches: [ main, pre-production, production ]

jobs:
  # Frontend Testing Job
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run tests with coverage
        working-directory: ./frontend
        run: npm run test:coverage
      
      - name: Upload frontend coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-report
          path: frontend/coverage/
          retention-days: 30
      
      - name: Display coverage summary
        working-directory: ./frontend
        run: |
          echo "## ðŸ“Š Frontend Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/coverage-summary.json').total; '| ðŸ“ Lines | '+d.lines.pct+'% ('+d.lines.covered+'/'+d.lines.total+') |'" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/coverage-summary.json').total; '| ðŸ“‹ Statements | '+d.statements.pct+'% ('+d.statements.covered+'/'+d.statements.total+') |'" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/coverage-summary.json').total; '| ðŸ”€ Branches | '+d.branches.pct+'% ('+d.branches.covered+'/'+d.branches.total+') |'" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/coverage-summary.json').total; '| âš¡ Functions | '+d.functions.pct+'% ('+d.functions.covered+'/'+d.functions.total+') |'" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Coverage summary not generated." >> $GITHUB_STEP_SUMMARY
          fi

  # Backend Testing Job
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
      
      - name: Install dependencies
        working-directory: ./server
        run: npm ci
      
      - name: Run tests with coverage
        working-directory: ./server
        env:
          MONGODB_URI: mongodb://localhost:27017/fitness-app-test
          JWT_SECRET: test-secret-key-for-ci
          NODE_ENV: test
        run: npm test
      
      - name: Upload backend coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: server/coverage/
          retention-days: 30
      
      - name: Display coverage summary
        working-directory: ./server
        run: |
          echo "## ðŸ“Š Backend Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/coverage-summary.json').total; '| ðŸ“ Lines | '+d.lines.pct+'% ('+d.lines.covered+'/'+d.lines.total+') |'" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/coverage-summary.json').total; '| ðŸ“‹ Statements | '+d.statements.pct+'% ('+d.statements.covered+'/'+d.statements.total+') |'" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/coverage-summary.json').total; '| ðŸ”€ Branches | '+d.branches.pct+'% ('+d.branches.covered+'/'+d.branches.total+') |'" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/coverage-summary.json').total; '| âš¡ Functions | '+d.functions.pct+'% ('+d.functions.covered+'/'+d.functions.total+') |'" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Coverage summary not generated." >> $GITHUB_STEP_SUMMARY
          fi

  # Combined Coverage Report Job
  coverage-report:
    name: Combined Coverage Report
    needs: [frontend-tests, backend-tests]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage-report
          path: ./coverage/frontend
      
      - name: Download backend coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage-report
          path: ./coverage/backend
      
      - name: Display combined coverage info
        run: |
          echo "# ðŸŽ¯ Combined Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸŽ¨ Frontend Coverage" >> $GITHUB_STEP_SUMMARY
          if [ -f ./coverage/frontend/coverage-summary.json ]; then
            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/frontend/coverage-summary.json').total; '| ðŸ“ Lines | '+d.lines.pct+'% ('+d.lines.covered+'/'+d.lines.total+') |'" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/frontend/coverage-summary.json').total; '| ðŸ“‹ Statements | '+d.statements.pct+'% ('+d.statements.covered+'/'+d.statements.total+') |'" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/frontend/coverage-summary.json').total; '| ðŸ”€ Branches | '+d.branches.pct+'% ('+d.branches.covered+'/'+d.branches.total+') |'" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/frontend/coverage-summary.json').total; '| âš¡ Functions | '+d.functions.pct+'% ('+d.functions.covered+'/'+d.functions.total+') |'" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Coverage data not available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš™ï¸ Backend Coverage" >> $GITHUB_STEP_SUMMARY
          if [ -f ./coverage/backend/coverage-summary.json ]; then
            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/backend/coverage-summary.json').total; '| ðŸ“ Lines | '+d.lines.pct+'% ('+d.lines.covered+'/'+d.lines.total+') |'" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/backend/coverage-summary.json').total; '| ðŸ“‹ Statements | '+d.statements.pct+'% ('+d.statements.covered+'/'+d.statements.total+') |'" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/backend/coverage-summary.json').total; '| ðŸ”€ Branches | '+d.branches.pct+'% ('+d.branches.covered+'/'+d.branches.total+') |'" >> $GITHUB_STEP_SUMMARY
            node -pe "const d=require('./coverage/backend/coverage-summary.json').total; '| âš¡ Functions | '+d.functions.pct+'% ('+d.functions.covered+'/'+d.functions.total+') |'" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Coverage data not available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Detailed HTML reports** are available as artifacts in the Actions tab above." >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¾ **Download artifacts:** \`frontend-coverage-report\` and \`backend-coverage-report\`" >> $GITHUB_STEP_SUMMARY
